var TitleAnimationView=Backbone.View.extend({width:350,height:224,initialize:function(){_.bindAll(this,"render"),this.intervalScale=d3.scale.linear().domain([0,25,50,75,100]).range([100,20,5,2,1]),this.i=0,this.nodes=[];var e=d3.select(this.el).select("svg");this.particles=e.selectAll("circle")},render:function(){var e=(this.height,this.width,[{x:116,y:124},{x:150,y:126},{x:161,y:140},{x:183,y:147},{x:203,y:148},{x:225,y:151}]),t=Math.floor(Math.random()*e.length),n={id:t,x:e[t].x,y:e[t].y,idx:this.i};this.nodes.push(n),this.nodes.length>300&&this.nodes.shift(),this.particles=this.particles.data(this.nodes,function(e){return e.idx}),this.particles.exit().remove(),this.particles.enter().append("circle").attr({"class":"particle",transform:function(e){var t=e.x,n=e.y;return"translate("+[t,n].join(" ")+")"},cx:0,cy:0,r:2}).style({fill:"#cc545b"}).transition().ease("cubic-out").duration(10500).attr({transform:function(){var n=e[t].x+50*(Math.random()-.5),a=0;return"translate("+[n,a].join(" ")+")"},r:10}).style({fill:"#333"}),this.i++;var a=this.intervalScale(this.model.get("progress"));console.log(a),setTimeout(this.render,a)}}),WaterfallCoalView=Backbone.View.extend({events:{"click .stage-next":"next","click .stage-prev":"back","mouseover .toggle-annotation-savings":"toggleAnnotationSavings","mouseout .toggle-annotation-savings":"toggleAnnotationSavings","mouseover .costs":"toggleCosts","mouseout .costs":"toggleCosts"},initialize:function(){_.bindAll(this,"render","next","back","update","toggleAnnotationSavings","toggleCosts"),this.model.on("change",this.update)},toggleAnnotationSavings:function(e){d3.select(this.el).select(".annotation-savings").classed("hidden","mouseout"==e.type)},toggleCosts:function(e){var t=d3.select(e.currentTarget).attr("class");d3.select(this.el).selectAll(".costs").style("opacity",function(){return"mouseout"==e.type?"":d3.select(this).attr("class")==t?"":.5})},next:function(){var e=this.model.get("stage")||1;return e=Math.min(2,e+1),this.model.set("stage",e),!1},back:function(){var e=this.model.get("stage")||1;return e=Math.max(1,e-1),this.model.set("stage",e),!1},update:function(){var e=this.model.get("stage")||1;d3.select(this.el).attr("class","chart-lg stage-"+e)},render:function(){this.update()}}),RetirementsChartView=Backbone.View.extend({events:{"click .stage-next":"next","click .stage-prev":"back","click .toggle-US":"toggle","click .toggle-EU":"toggle"},initialize:function(){_.bindAll(this,"render","next","back","update","toggle"),this.model.on("change",this.update)},next:function(){var e=this.model.get("stage")||1;return e=Math.min(3,e+1),this.model.set("stage",e),!1},back:function(){var e=this.model.get("stage")||1;return e=Math.max(1,e-1),this.model.set("stage",e),!1},toggle:function(e){var t=$(e.currentTarget).attr("class"),n=t.split("-")[1];return this.model.set({stage:1,toggle:n}),!1},update:function(){var e=this.model.get("stage")||1,t=this.model.get("toggle")||"US";d3.select(this.el).attr("class","chart-lg retirements "+t+" stage-"+e),d3.select(this.el).select("svg."+t).attr("class",t+" stage-"+e)},render:function(){this.update()}}),LowHangingFruitView=Backbone.View.extend({width:750,height:300,interval:5,numBubbles:750,events:{"click .stage-next":"next"},initialize:function(){_.bindAll(this,"render","next")},next:function(){return this.$el.addClass("stage2"),!1},render:function(){var e=this.height,t=this.width,n=this.interval,a=[],i=d3.scale.linear().domain([0,14.01,22.01,100]).range([0,1,2,3]),r=2,s=8,o=[d3.scale.linear().domain([0,1]).range([s,98-s]),d3.scale.linear().domain([0,1]).range([125+s,181-s]),d3.scale.linear().domain([0,1]).range([204+s,750-s])],l=[d3.scale.linear().domain([0,1]).range([0,546]),d3.scale.linear().domain([0,1]).range([572,632]),d3.scale.linear().domain([0,1]).range([650,750])],c=d3.scale.linear().domain([0,1]).range([0,40]),d=d3.select(this.el).select("svg").attr({width:t,height:e}),g=0,h=d.selectAll("circle"),u=["oil","gas","coal"],m=this.numBubbles,n=this.interval;setInterval(function(){var t=(new Date,Math.floor(i(100*Math.random()))),n={id:t,x:l[t](Math.random()),y:e,idx:g};a.push(n),a.length>m&&a.shift(),h=h.data(a,function(e){return e.idx}),h.exit().remove(),h.enter().append("circle").attr({"class":function(e){return"particle "+u[e.id]},transform:function(t){var n=t.x,a=e;return"translate("+[n,a].join(" ")+")"},cx:0,cy:0,r:r}).transition().ease("cubic-out").duration(2e4).attr({transform:function(e){var t=o[e.id](Math.random()),n=c(Math.random());return"translate("+[t,n].join(" ")+")"},r:s}),g++},n)}}),PolicyScenario=Backbone.View.extend({initialize:function(e){_.bindAll(this,"render"),this.data=e.data},render:function(){var e=this.data,t=this.model.get("index")||0,n=e[t],a=[n.value_loss,n.higher_costs,n.tax_revenue,n.net_gain],i=d3.format(".1f"),r=d3.select(this.el),s=r.select(".svg-detail svg");r.select("#country-name").text(n.region);var o=s.selectAll(".bar").data(a),l=d3.scale.linear().domain([0,d3.max(a,function(e){return Math.abs(e)})]).range([0,71]),c=o.enter().append("g").attr({"class":"bar",transform:function(e,t){var n=0,a=80*t+10;return"translate("+[n,a].join(" ")+")"}});c.append("rect").attr({height:30}),c.append("text").attr({"class":"num-label","text-anchor":"middle",transform:function(){var e=100,t=20;return"translate("+[e,t].join(" ")+")"}}),o.selectAll("rect").transition().attr({transform:function(e){var t=e>=0?129:71+l(e),n=0;return"translate("+[t,n].join(" ")+")"},width:function(e){return Math.abs(l(e))}}),o.select(".num-label").text(function(e){return e>0?"+"+i(e/1e3):i(e/1e3)})}}),PolicyScenarioCountries=PolicyScenario.extend({events:{"click #net-country-1":"changeCountry","click #net-country-2":"changeCountry","click #net-country-3":"changeCountry","click #net-country-4":"changeCountry","click #net-country-5":"changeCountry","click #net-country-6":"changeCountry"},initialize:function(e){_.bindAll(this,"render","changeCountry"),this.data=e.data,this.model.on("change:index",this.render)},changeCountry:function(e){var t=parseInt($(e.currentTarget).attr("id").split("-")[2]);this.model.set("index",t-1)}}),Model=Backbone.Model.extend({});$(document).ready(function(){var e=new LowHangingFruitView({el:"#low-hanging-fruit"});e.render();var t=new Model({progress:0}),n=new TitleAnimationView({el:"#intro",model:t});n.render();var a=new RetirementsChartView({el:"#chart-retirements",model:new Model({stage:0,toggle:"US"})});a.render();var i=new WaterfallCoalView({el:"#waterfall-coal",model:new Model({stage:1})});i.render();var r=new WaterfallCoalView({el:"#waterfall-transport",model:new Model({stage:1})});r.render(),d3.json("data/scenarios.json",function(e){var t=e.taxes,n=e.innovation,a=e.countries,i=new PolicyScenario({model:new Model,data:t,el:"#scenario-taxes-cost"});i.render();var r=new PolicyScenario({model:new Model,data:n,el:"#scenario-innovation"});r.render();var s=new PolicyScenarioCountries({model:new Model({index:0}),data:a,el:"#scenario-taxes-consumer-benefit"});s.render()});var s=1500;$(window).scroll(function(){var e=$(this).scrollTop(),n=100/s*e;n>100||t.set("progress",n)})});